

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>More filtering mojo for your analytics &mdash; Ibis 0.4.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Ibis 0.4.0 documentation" href="../index.html"/>
        <link rel="up" title="Tutorial" href="../tutorial.html"/>
        <link rel="next" title="Frequency tables" href="7.html"/>
        <link rel="prev" title="“Top-K” Filtering" href="5.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../index.html" class="fa fa-home"> Ibis</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Installation and Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started.html#creating-a-client">Creating a client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started.html#learning-resources">Learning resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started.html#using-ibis-with-the-cloudera-quickstart-vm">Using Ibis with the Cloudera Quickstart VM</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Configuring Ibis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#ibis-global-configuration">Ibis global configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#working-with-secure-clusters-kerberos">Working with secure clusters (Kerberos)</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="0.html">Intro and Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="0.html#getting-started">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html">Basics: Aggregation, filtering, limits</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html#accessing-an-impala-table">Accessing an Impala table</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html#column-selection-and-basic-expressions">Column selection and basic expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html#interactive-mode">Interactive mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html#verbose-mode-and-logging">Verbose mode and logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html#aggregation-basics">Aggregation basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html#filtering">Filtering</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html#limits">Limits</a></li>
<li class="toctree-l2"><a class="reference internal" href="2.html">Projections: adding/selecting columns</a></li>
<li class="toctree-l2"><a class="reference internal" href="2.html#joins">Joins</a></li>
<li class="toctree-l2"><a class="reference internal" href="2.html#joins-are-declarations-of-intent">Joins are declarations of intent</a></li>
<li class="toctree-l2"><a class="reference internal" href="2.html#explicit-join-materialization">Explicit join materialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="2.html#writing-down-join-keys">Writing down join keys</a></li>
<li class="toctree-l2"><a class="reference internal" href="2.html#join-referential-nuances">Join referential nuances</a></li>
<li class="toctree-l2"><a class="reference internal" href="2.html#aggregating-joined-table-with-metrics-involving-more-than-one-base-reference">Aggregating joined table with metrics involving more than one base reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="2.html#sorting">Sorting</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.html">Type casting</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.html#case-if-then-else-expressions">Case / if-then-else expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.html#set-membership">Set membership</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.html#null-ness">Null-ness</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.html#distinct-based-operations">Distinct-based operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.html#string-operations">String operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.html#timestamp-operations">Timestamp operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.html">Creating new Impala tables from Ibis expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.html#inserting-data-into-existing-impala-tables">Inserting data into existing Impala tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.html#uploading-downloading-data-from-hdfs">Uploading / downloading data from HDFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.html#queries-on-parquet-avro-and-delimited-files-in-hdfs">Queries on Parquet, Avro, and Delimited files in HDFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.html#other-helper-functions-for-interacting-with-the-database">Other helper functions for interacting with the database</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.html#dealing-with-partitioned-tables-in-impala">Dealing with Partitioned tables in Impala</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.html#faster-queries-on-small-data-in-impala">Faster queries on small data in Impala</a></li>
<li class="toctree-l2"><a class="reference internal" href="5.html">&#8220;Top-K&#8221; Filtering</a></li>
<li class="toctree-l2"><a class="reference internal" href="5.html#self-joins">Self joins</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">More filtering mojo for your analytics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-scalar-aggregates-in-filters">Using scalar aggregates in filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#conditional-aggregates">Conditional aggregates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#existence-filters">&#8220;Existence&#8221; filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="7.html">Frequency tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="7.html#binning-and-histograms">Binning and histograms</a></li>
<li class="toctree-l2"><a class="reference internal" href="7.html#filtering-in-aggregations">Filtering in aggregations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../impala-udf.html">Using Impala UDFs in Ibis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../impala-udf.html#using-scalar-functions-udfs">Using scalar functions (UDFs)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../impala-udf.html#using-aggregate-functions-udas">Using aggregate functions (UDAs)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../impala-udf.html#adding-udf-functions-to-ibis-types">Adding UDF functions to Ibis types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../impala-udf.html#installing-the-impala-udf-sdk-on-os-x-and-linux">Installing the Impala UDF SDK on OS X and Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../impala-udf.html#impala-types-to-ibis-types">Impala types to Ibis types</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api.html#creating-connections">Creating connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#impala-client">Impala client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#hdfs">HDFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#top-level-expression-apis">Top-level expression APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#api-table">Table methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#generic-value-methods">Generic value methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#general-numeric-methods">General numeric methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#integer-methods">Integer methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#string-methods">String methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#timestamp-methods">Timestamp methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#boolean-methods">Boolean methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#category-methods">Category methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#decimal-methods">Decimal methods</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../sql.html">Ibis for SQL Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../impala.html">Ibis for Impala users</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../impala.html#table-metadata">Table metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../impala.html#table-partition-management">Table partition management</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release.html">Release Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../release.html#august-14-2015">0.4.0 (August 14, 2015)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release.html#july-20-2015">0.3.0 (July 20, 2015)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release.html#june-16-2015">0.2.0 (June 16, 2015)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release.html#march-26-2015">0.1.0 (March 26, 2015)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../developer.html">Developing and Contributing to Ibis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer.html#test-environment-setup">Test environment setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer.html#contribution-ideas">Contribution Ideas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer.html#contributor-license-agreements">Contributor License Agreements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../type-system.html">Ibis design internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legal.html">Legal</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Ibis</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../tutorial.html">Tutorial</a> &raquo;</li>
      
    <li>More filtering mojo for your analytics</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../_sources/generated-notebooks/6.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="more-filtering-mojo-for-your-analytics">
<h1>More filtering mojo for your analytics<a class="headerlink" href="#more-filtering-mojo-for-your-analytics" title="Permalink to this headline">¶</a></h1>
<p>The filtering examples we&#8217;ve shown to this point have been pretty
simple, either comparisons between columns or fixed values, or set
filter functions like <code class="docutils literal"><span class="pre">isin</span></code> and <code class="docutils literal"><span class="pre">notin</span></code>.</p>
<p>Ibis supports a number of richer analytical filters that can involve one
or more of:</p>
<ul class="simple">
<li>Aggregates computed from the same or other tables</li>
<li>Conditional aggregates (in SQL-speak these are similar to &#8220;correlated
subqueries&#8221;)</li>
<li>&#8220;Existence&#8221; set filters (equivalent to the SQL <code class="docutils literal"><span class="pre">EXISTS</span></code> and
<code class="docutils literal"><span class="pre">NOT</span> <span class="pre">EXISTS</span></code> keywords)</li>
</ul>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">ibis</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">hdfs_port</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;IBIS_WEBHDFS_PORT&#39;</span><span class="p">,</span> <span class="mi">50070</span><span class="p">)</span>

<span class="n">ic</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;quickstart.cloudera&#39;</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="s">&#39;ibis_testing&#39;</span><span class="p">)</span>
<span class="n">hdfs</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">hdfs_connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;quickstart.cloudera&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">hdfs_port</span><span class="p">)</span>
<span class="n">con</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">make_client</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">hdfs_client</span><span class="o">=</span><span class="n">hdfs</span><span class="p">)</span>

<span class="n">ibis</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
</div>
<div class="section" id="using-scalar-aggregates-in-filters">
<h1>Using scalar aggregates in filters<a class="headerlink" href="#using-scalar-aggregates-in-filters" title="Permalink to this headline">¶</a></h1>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">table</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;functional_alltypes&#39;</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">
     id bool_col  tinyint_col  smallint_col  int_col  bigint_col  float_col  0  6690     True            0             0        0           0        0.0
1  6691    False            1             1        1          10        1.1
2  6692     True            2             2        2          20        2.2
3  6693    False            3             3        3          30        3.3
4  6694     True            4             4        4          40        4.4

   double_col date_string_col string_col           timestamp_col  year  month
0         0.0        11/01/10          0 2010-11-01 00:00:00.000  2010     11
1        10.1        11/01/10          1 2010-11-01 00:01:00.000  2010     11
2        20.2        11/01/10          2 2010-11-01 00:02:00.100  2010     11
3        30.3        11/01/10          3 2010-11-01 00:03:00.300  2010     11
4        40.4        11/01/10          4 2010-11-01 00:04:00.600  2010     11
</pre>
<p>We could always compute some aggregate value from the table and use that
in another expression, or we can use a data-derived aggregate in the
filter. Take the average of a column for example:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">table</span><span class="o">.</span><span class="n">double_col</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mf">45.450000000000003</span>
</pre></div>
</div>
<p>You can use this expression as a substitute for a scalar value in a
filter, and the execution engine will combine everything into a single
query rather than having to access Impala multiple times:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">cond</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">bigint_col</span> <span class="o">&gt;</span> <span class="n">table</span><span class="o">.</span><span class="n">double_col</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">expr</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">cond</span> <span class="o">&amp;</span> <span class="n">table</span><span class="o">.</span><span class="n">bool_col</span><span class="p">]</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">expr</span>
</pre></div>
</div>
<pre class="literal-block">
     id bool_col  tinyint_col  smallint_col  int_col  bigint_col  float_col  0  6696     True            6             6        6          60        6.6
1  6698     True            8             8        8          80        8.8
2  6706     True            6             6        6          60        6.6
3  6708     True            8             8        8          80        8.8
4  6716     True            6             6        6          60        6.6

   double_col date_string_col string_col           timestamp_col  year  month
0        60.6        11/01/10          6 2010-11-01 00:06:00.150  2010     11
1        80.8        11/01/10          8 2010-11-01 00:08:00.280  2010     11
2        60.6        11/02/10          6 2010-11-02 00:16:00.600  2010     11
3        80.8        11/02/10          8 2010-11-02 00:18:00.730  2010     11
4        60.6        11/03/10          6 2010-11-03 00:26:01.500  2010     11
</pre>
</div>
<div class="section" id="conditional-aggregates">
<h1>Conditional aggregates<a class="headerlink" href="#conditional-aggregates" title="Permalink to this headline">¶</a></h1>
<p>Suppose that we wish to filter using an aggregate computed conditional
on some other expressions holding true. Using the TPC-H datasets,
suppose that we want to filter customers based on the following
criteria: Orders such that their amount exceeds the average amount for
their sales region over the whole dataset. This can be computed any
numbers of ways (such as joining auxiliary tables and filtering
post-join)</p>
<p>Again, from prior examples, here are the joined up tables with all the
customer data:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">region</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;tpch_region&#39;</span><span class="p">)</span>
<span class="n">nation</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;tpch_nation&#39;</span><span class="p">)</span>
<span class="n">customer</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;tpch_customer&#39;</span><span class="p">)</span>
<span class="n">orders</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;tpch_orders&#39;</span><span class="p">)</span>

<span class="n">fields_of_interest</span> <span class="o">=</span> <span class="p">[</span><span class="n">customer</span><span class="p">,</span>
                      <span class="n">region</span><span class="o">.</span><span class="n">r_name</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;region&#39;</span><span class="p">),</span>
                      <span class="n">orders</span><span class="o">.</span><span class="n">o_totalprice</span><span class="p">,</span>
                      <span class="n">orders</span><span class="o">.</span><span class="n">o_orderdate</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s">&#39;timestamp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;odate&#39;</span><span class="p">)]</span>

<span class="n">tpch</span> <span class="o">=</span> <span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nation</span><span class="p">,</span> <span class="n">region</span><span class="o">.</span><span class="n">r_regionkey</span> <span class="o">==</span> <span class="n">nation</span><span class="o">.</span><span class="n">n_regionkey</span><span class="p">)</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">customer</span><span class="o">.</span><span class="n">c_nationkey</span> <span class="o">==</span> <span class="n">nation</span><span class="o">.</span><span class="n">n_nationkey</span><span class="p">)</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">orders</span><span class="o">.</span><span class="n">o_custkey</span> <span class="o">==</span> <span class="n">customer</span><span class="o">.</span><span class="n">c_custkey</span><span class="p">)</span>
        <span class="p">[</span><span class="n">fields_of_interest</span><span class="p">])</span>

<span class="n">tpch</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">
   c_custkey              c_name                    c_address  c_nationkey  0      36901  Customer#000036901         TBb1yDZcf 8Zepk7apFJ           13
1      78002  Customer#000078002                   v7Jkg5XIqM           10
2      44485  Customer#000044485              hlyA8oJVqUQfBOb           20
3      55624  Customer#000055624           ZnDi05oHDsw0Bt2glb            7
4     130057  Customer#000130057  jQDBlCU2IlHmzkDfcqgIHg2eLsN            9

           c_phone c_acctbal c_mktsegment  0  23-644-998-4944   4809.84   AUTOMOBILE
1  20-715-308-7926   4128.41   AUTOMOBILE
2  30-452-969-2072   4543.02    FURNITURE
3  17-796-839-5728    818.33   AUTOMOBILE
4  19-938-862-4157   5009.55    FURNITURE

                                           c_comment       region  0  nstructions sleep final, regular deposits. qui...  MIDDLE EAST
1    ly after the special deposits. careful packages  MIDDLE EAST
2                ng excuses cajole along the silent,  MIDDLE EAST
3                     uickly special foxes according       EUROPE
4   blithely regular packages. carefully bold acc...         ASIA

  o_totalprice      odate
0    173665.47 1996-01-02
1     46929.18 1996-12-01
2    144659.20 1994-07-30
3     58749.59 1992-02-21
4    208660.75 1995-07-16
</pre>
<p>In this particular case, filtering based on the conditional average
<code class="docutils literal"><span class="pre">o_totalprice</span></code> by region requires creating a table view (similar to
the self-join examples from earlier) that can be treated as a distinct
table entity in the expression. This would <strong>not</strong> be required if we
were computing a conditional statistic from some other table. So this is
a little more complicated than some other cases would be:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">t2</span> <span class="o">=</span> <span class="n">tpch</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
<span class="n">conditional_avg</span> <span class="o">=</span> <span class="n">t2</span><span class="p">[(</span><span class="n">t2</span><span class="o">.</span><span class="n">region</span> <span class="o">==</span> <span class="n">tpch</span><span class="o">.</span><span class="n">region</span><span class="p">)]</span><span class="o">.</span><span class="n">o_totalprice</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
<p>Once you&#8217;ve done this, you can use the conditional average in a filter
expression</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">amount_filter</span> <span class="o">=</span> <span class="n">tpch</span><span class="o">.</span><span class="n">o_totalprice</span> <span class="o">&gt;</span> <span class="n">conditional_avg</span>
<span class="n">tpch</span><span class="p">[</span><span class="n">amount_filter</span><span class="p">]</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">
   c_custkey              c_name                                c_address  0     123314  Customer#000123314     nKPmaZi,OKhObOYSL3wc egXR4Vt99CXRclF
1      39136  Customer#000039136          afZJC1mWpwvsfKT0211ZD6NQXVGETfl
2      66958  Customer#000066958              h5jsmOq8nxf8Pz1Knqe GZdK4lh
3     127588  Customer#000127588        DbnvQxsG0,Nobhbj6n5cMUNPjfouzdFzH
4      81763  Customer#000081763       mZtn4M5r0KIw4aooP BXF3ReR RUlPJcAb
5      28547  Customer#000028547              AeWmD3BLrsSkmRY7O,wbB75i6Ll
6      84487  Customer#000084487  ROq5UJr 3Z39GkrBCjdiVa,q Mc83GUHfu2dGhI
7      36964  Customer#000036964                               Q5MxajLIyE
8      87760  Customer#000087760              wr71AaU5686WwQSWjZo6uMtj8J7
9        779  Customer#000000779      2cTZiS4ulZ74edT,RmDnh4ZaCrphMMh Ff2

   c_nationkey          c_phone c_acctbal c_mktsegment  0           15  25-884-345-1592   -686.40    MACHINERY
1            5  15-400-347-1643   5555.41    FURNITURE
2           18  28-393-112-1873   9160.79    MACHINERY
3           14  24-409-883-5840    358.38     BUILDING
4            8  18-425-613-5972   8368.23    MACHINERY
5            1  11-711-951-5798   2095.42    MACHINERY
6           12  22-872-263-3878   -659.55    HOUSEHOLD
7           14  24-753-859-6273   6495.22    HOUSEHOLD
8            3  13-124-384-6455   9206.03     BUILDING
9            5  15-940-483-5702   -902.48    HOUSEHOLD

                                           c_comment   region o_totalprice  0             ounts serve furiously. carefully expre   AFRICA    193846.25
1  y? express theodolites haggle against the bold...   AFRICA    252004.18
2  ggle quickly after the carefully stealthy depo...     ASIA    163243.98
3                  accounts wake slyly along the bli   AFRICA    253724.56
4  ronic frays. slyly pending pinto beans are fur...     ASIA    341734.47
5  y regular foxes nag quickly after the express,...  AMERICA    330793.52
6  fluffily express deposits sleep furiously slyl...     ASIA    197689.49
7  ld courts. even deposits detect after the bold...   AFRICA    189484.12
8  . pending, pending packages dazzle furiously a...  AMERICA    202379.28
9   old dependencies. pains haggle fluffily carefull   AFRICA    301925.76

       odate
0 1993-10-14
1 1996-01-10
2 1993-10-27
3 1995-10-23
4 1996-09-20
5 1998-04-18
6 1994-06-04
7 1992-05-08
8 1997-09-05
9 1992-10-21
</pre>
<p>By looking at the table sizes before and after applying the filter you
can see the relative size of the subset taken.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">tpch</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">1500000</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">tpch</span><span class="p">[</span><span class="n">amount_filter</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">711969</span>
</pre></div>
</div>
<p>Or even group by year and compare before and after:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">year</span> <span class="o">=</span> <span class="n">tpch</span><span class="o">.</span><span class="n">odate</span><span class="o">.</span><span class="n">year</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;year&#39;</span><span class="p">)</span>

<span class="n">pre_sizes</span> <span class="o">=</span> <span class="n">tpch</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
<span class="n">post_sizes</span> <span class="o">=</span> <span class="n">tpch</span><span class="p">[</span><span class="n">amount_filter</span><span class="p">]</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

<span class="n">percent</span> <span class="o">=</span> <span class="p">((</span><span class="n">post_sizes</span><span class="p">[</span><span class="s">&#39;count&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pre_sizes</span><span class="p">[</span><span class="s">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s">&#39;double&#39;</span><span class="p">))</span>
           <span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;fraction&#39;</span><span class="p">))</span>

<span class="n">expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pre_sizes</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">post_sizes</span><span class="p">,</span> <span class="n">pre_sizes</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">post_sizes</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
        <span class="p">[</span><span class="n">pre_sizes</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
         <span class="n">pre_sizes</span><span class="p">[</span><span class="s">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;pre_count&#39;</span><span class="p">),</span>
         <span class="n">post_sizes</span><span class="p">[</span><span class="s">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;post_count&#39;</span><span class="p">),</span>
         <span class="n">percent</span><span class="p">])</span>
<span class="n">expr</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>   year  pre_count  post_count  fraction
0  1994     227597      108087  0.474905
1  1996     228626      108757  0.475698
2  1992     227089      107815  0.474770
3  1998     133623       63551  0.475599
4  1993     226645      107703  0.475206
5  1995     228637      108315  0.473742
6  1997     227783      107741  0.472998
</pre></div>
</div>
</div>
<div class="section" id="existence-filters">
<h1>&#8220;Existence&#8221; filters<a class="headerlink" href="#existence-filters" title="Permalink to this headline">¶</a></h1>
<p>Some filtering involves checking for the existence of a particular value
in a column of another table, or amount the results of some value
expression. This is common in many-to-many relationships, and can be
performed in numerous different ways, but it&#8217;s nice to be able to
express it with a single concise statement and let Ibis compute it
optimally.</p>
<p>Here&#8217;s some examples:</p>
<ul class="simple">
<li>Filter down to customers having at least one open order</li>
<li>Find customers having no open orders with 1-URGENT status</li>
<li>Find stores (in the stores table) having the same name as a vendor
(in the vendors table).</li>
</ul>
<p>We&#8217;ll go ahead and solve the first couple of these problems using the
TPC-H tables to illustrate the API:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">customer</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;tpch_customer&#39;</span><span class="p">)</span>
<span class="n">orders</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;tpch_orders&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">orders</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">
   o_orderkey  o_custkey o_orderstatus o_totalprice o_orderdate  0           1      36901             O    173665.47  1996-01-02
1           2      78002             O     46929.18  1996-12-01
2           3     123314             F    193846.25  1993-10-14
3           4     136777             O     32151.78  1995-10-11
4           5      44485             F    144659.20  1994-07-30

  o_orderpriority          o_clerk  o_shippriority  0           5-LOW  Clerk#000000951               0
1        1-URGENT  Clerk#000000880               0
2           5-LOW  Clerk#000000955               0
3           5-LOW  Clerk#000000124               0
4           5-LOW  Clerk#000000925               0

                                           o_comment
0                 nstructions sleep furiously among
1   foxes. pending accounts at the pending, silen...
2  sly final accounts boost. carefully regular id...
3  sits. slyly regular warthogs cajole. regular, ...
4  quickly. bold deposits sleep slyly. packages u...
</pre>
<p>We introduce the <code class="docutils literal"><span class="pre">any</span></code> reduction:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">has_open_orders</span> <span class="o">=</span> <span class="p">((</span><span class="n">orders</span><span class="o">.</span><span class="n">o_orderstatus</span> <span class="o">==</span> <span class="s">&#39;O&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">c_custkey</span> <span class="o">==</span> <span class="n">orders</span><span class="o">.</span><span class="n">o_custkey</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
</pre></div>
</div>
<p>This is now a valid filter:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">customer</span><span class="p">[</span><span class="n">has_open_orders</span><span class="p">]</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">
   c_custkey              c_name                              c_address  0          1  Customer#000000001                      IVhzIApeRb ot,c,E
1          2  Customer#000000002         XSTf4,NCwDVaWNe6tEgvwfmRchLXak
2          4  Customer#000000004                            XxVSJsLAGtn
3          5  Customer#000000005           KvpyuHCplrB84WgAiGV6sYpZq7Tj
4          7  Customer#000000007         TcGe5gaZNgVePxU5kRrvXBfkasDTea
5          8  Customer#000000008  I0B10bB0AymmC, 0PrRYBCP1yGJ8xcBPmWhl5
6         10  Customer#000000010     6LrEaV6KR6PLVcgl2ArL Q3rqzLzcT1 v2
7         11  Customer#000000011                PkWS 3HlXqwTuzrKg633BEi
8         13  Customer#000000013                nsXQu0oVjD7PM659uC3SRSp
9         14  Customer#000000014                        KXkletMlL2JQEA

   c_nationkey          c_phone c_acctbal c_mktsegment  0           15  25-989-741-2988    711.56     BUILDING
1           13  23-768-687-3665    121.65   AUTOMOBILE
2            4  14-128-190-5944   2866.83    MACHINERY
3            3  13-750-942-6364    794.47    HOUSEHOLD
4           18  28-190-982-9759   9561.95   AUTOMOBILE
5           17  27-147-574-9335   6819.74     BUILDING
6            5  15-741-346-9870   2753.54    HOUSEHOLD
7           23  33-464-151-3439   -272.60     BUILDING
8            3  13-761-547-5974   3857.34     BUILDING
9            1  11-845-129-3851   5266.30    FURNITURE

                                           c_comment
0  to the even, regular platelets. regular, ironi...
1  l accounts. blithely ironic theodolites integr...
2   requests. final, regular ideas sleep final accou
3  n accounts will have to unwind. foxes cajole a...
4  ainst the ironic, express theodolites. express...
5  among the slyly regular theodolites kindle bli...
6                    es regular deposits haggle. fur
7  ckages. requests sleep slyly. quickly even pin...
8  ounts sleep carefully after the close frays. c...
9                  , ironic packages across the unus
</pre>
<p>For the second example, in which we want to find customers not having
any open urgent orders, we write down the condition that they <em>do</em> have
some first:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">has_open_urgent_orders</span> <span class="o">=</span> <span class="p">((</span><span class="n">orders</span><span class="o">.</span><span class="n">o_orderstatus</span> <span class="o">==</span> <span class="s">&#39;O&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                          <span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">o_orderpriority</span> <span class="o">==</span> <span class="s">&#39;1-URGENT&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                          <span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">c_custkey</span> <span class="o">==</span> <span class="n">orders</span><span class="o">.</span><span class="n">o_custkey</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
</pre></div>
</div>
<p>Now, we can negate this condition and use it as a filter:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">customer</span><span class="p">[</span><span class="o">-</span><span class="n">has_open_urgent_orders</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">75801</span>
</pre></div>
</div>
<p>In this case, it is true that <code class="docutils literal"><span class="pre">customer.c_custkey</span></code> has no duplicate
values, but that need not be the case. There could be multiple copies of
any given value in either table column being compared, and the behavior
will be the same (existence or non-existence is verified).</p>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="7.html" class="btn btn-neutral float-right" title="Frequency tables">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="5.html" class="btn btn-neutral" title="“Top-K” Filtering"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Cloudera, Inc..
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.4.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-65303298-2', 'auto');
  ga('send', 'pageview');

</script>


</body>
</html>