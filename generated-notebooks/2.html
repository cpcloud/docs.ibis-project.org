

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Projections: adding/selecting columns &mdash; Ibis 0.3.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Ibis 0.3.0 documentation" href="../index.html"/>
        <link rel="up" title="Tutorial" href="../tutorial.html"/>
        <link rel="next" title="Type casting" href="3.html"/>
        <link rel="prev" title="Basics: Aggregation, filtering, limits" href="1.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../index.html" class="fa fa-home"> Ibis</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Installation and Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started.html#creating-a-client">Creating a client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started.html#learning-resources">Learning resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started.html#using-ibis-with-the-cloudera-quickstart-vm">Using Ibis with the Cloudera Quickstart VM</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Configuring Ibis</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="0.html">Intro and Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="0.html#getting-started">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html">Basics: Aggregation, filtering, limits</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html#accessing-an-impala-table">Accessing an Impala table</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html#column-selection-and-basic-expressions">Column selection and basic expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html#interactive-mode">Interactive mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html#verbose-mode-and-logging">Verbose mode and logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html#aggregation-basics">Aggregation basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html#filtering">Filtering</a></li>
<li class="toctree-l2"><a class="reference internal" href="1.html#limits">Limits</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Projections: adding/selecting columns</a></li>
<li class="toctree-l2"><a class="reference internal" href="#joins">Joins</a></li>
<li class="toctree-l2"><a class="reference internal" href="#joins-are-declarations-of-intent">Joins are declarations of intent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#explicit-join-materialization">Explicit join materialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-down-join-keys">Writing down join keys</a></li>
<li class="toctree-l2"><a class="reference internal" href="#join-referential-nuances">Join referential nuances</a></li>
<li class="toctree-l2"><a class="reference internal" href="#aggregating-joined-table-with-metrics-involving-more-than-one-base-reference">Aggregating joined table with metrics involving more than one base reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sorting">Sorting</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.html">Type casting</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.html#case-if-then-else-expressions">Case / if-then-else expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.html#set-membership">Set membership</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.html#null-ness">Null-ness</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.html#distinct-based-operations">Distinct-based operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.html#string-operations">String operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.html#timestamp-operations">Timestamp operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.html">Creating new Impala tables from Ibis expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.html#inserting-data-into-existing-impala-tables">Inserting data into existing Impala tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.html#uploading-downloading-data-from-hdfs">Uploading / downloading data from HDFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.html#queries-on-parquet-avro-and-delimited-files-in-hdfs">Queries on Parquet, Avro, and Delimited files in HDFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.html#other-helper-functions-for-interacting-with-the-database">Other helper functions for interacting with the database</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.html#dealing-with-partitioned-tables-in-impala">Dealing with Partitioned tables in Impala</a></li>
<li class="toctree-l2"><a class="reference internal" href="4.html#faster-queries-on-small-data-in-impala">Faster queries on small data in Impala</a></li>
<li class="toctree-l2"><a class="reference internal" href="5.html">&#8220;Top-K&#8221; Filtering</a></li>
<li class="toctree-l2"><a class="reference internal" href="5.html#self-joins">Self joins</a></li>
<li class="toctree-l2"><a class="reference internal" href="6.html">More filtering mojo for your analytics</a></li>
<li class="toctree-l2"><a class="reference internal" href="6.html#using-scalar-aggregates-in-filters">Using scalar aggregates in filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="6.html#conditional-aggregates">Conditional aggregates</a></li>
<li class="toctree-l2"><a class="reference internal" href="6.html#existence-filters">&#8220;Existence&#8221; filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="7.html">Frequency tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="7.html#binning-and-histograms">Binning and histograms</a></li>
<li class="toctree-l2"><a class="reference internal" href="7.html#filtering-in-aggregations">Filtering in aggregations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api.html#creating-connections">Creating connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#impala-client">Impala client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#hdfs">HDFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#top-level-expression-apis">Top-level expression APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#api-table">Table methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#generic-value-methods">Generic value methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#general-numeric-methods">General numeric methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#integer-methods">Integer methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#string-methods">String methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#timestamp-methods">Timestamp methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#boolean-methods">Boolean methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#category-methods">Category methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#decimal-methods">Decimal methods</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release.html">Release Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../release.html#july-20-2015">0.3.0 (July 20, 2015)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release.html#june-16-2015">0.2.0 (June 16, 2015)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release.html#march-26-2015">0.1.0 (March 26, 2015)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../developer.html">Developing and Contributing to Ibis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer.html#test-environment-setup">Test environment setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer.html#contribution-ideas">Contribution Ideas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer.html#contributor-license-agreements">Contributor License Agreements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../type-system.html">Ibis design internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legal.html">Legal</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Ibis</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../tutorial.html">Tutorial</a> &raquo;</li>
      
    <li>Projections: adding/selecting columns</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../_sources/generated-notebooks/2.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">ibis</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">hdfs_port</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;IBIS_WEBHDFS_PORT&#39;</span><span class="p">,</span> <span class="mi">50070</span><span class="p">)</span>

<span class="n">ic</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">impala_connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;quickstart.cloudera&#39;</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="s">&#39;ibis_testing&#39;</span><span class="p">)</span>
<span class="n">hdfs</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">hdfs_connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;quickstart.cloudera&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">hdfs_port</span><span class="p">)</span>
<span class="n">con</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">make_client</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">hdfs_client</span><span class="o">=</span><span class="n">hdfs</span><span class="p">)</span>

<span class="n">ibis</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<div class="section" id="projections-adding-selecting-columns">
<h1>Projections: adding/selecting columns<a class="headerlink" href="#projections-adding-selecting-columns" title="Permalink to this headline">¶</a></h1>
<p>Projections are the general way for adding new columns to tables, or
selecting or removing existing ones.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">table</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;functional_alltypes&#39;</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">
     id bool_col  tinyint_col  smallint_col  int_col  bigint_col  float_col  0  5460     True            0             0        0           0        0.0
1  5461    False            1             1        1          10        1.1
2  5462     True            2             2        2          20        2.2
3  5463    False            3             3        3          30        3.3
4  5464     True            4             4        4          40        4.4

   double_col date_string_col string_col           timestamp_col  year  month
0         0.0        07/01/10          0 2010-07-01 00:00:00.000  2010      7
1        10.1        07/01/10          1 2010-07-01 00:01:00.000  2010      7
2        20.2        07/01/10          2 2010-07-01 00:02:00.100  2010      7
3        30.3        07/01/10          3 2010-07-01 00:03:00.300  2010      7
4        40.4        07/01/10          4 2010-07-01 00:04:00.600  2010      7
</pre>
<p>First, the basics: selecting columns:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">proj</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s">&#39;bool_col&#39;</span><span class="p">,</span> <span class="s">&#39;int_col&#39;</span><span class="p">,</span> <span class="s">&#39;double_col&#39;</span><span class="p">]</span>

<span class="n">proj</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>  bool_col  int_col  double_col
0     True        0         0.0
1    False        1        10.1
2     True        2        20.2
3    False        3        30.3
4     True        4        40.4
</pre></div>
</div>
<p>You can make a list of columns you want, too, and pass that:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">to_select</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;bool_col&#39;</span><span class="p">,</span> <span class="s">&#39;int_col&#39;</span><span class="p">]</span>
<span class="n">table</span><span class="p">[</span><span class="n">to_select</span><span class="p">]</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>  bool_col  int_col
0     True        0
1    False        1
2     True        2
3    False        3
4     True        4
</pre></div>
</div>
<p>You can also use the explicit <code class="docutils literal"><span class="pre">projection</span></code> or <code class="docutils literal"><span class="pre">select</span></code> functions</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">table</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s">&#39;int_col&#39;</span><span class="p">,</span> <span class="s">&#39;double_col&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>   int_col  double_col
0        0         0.0
1        1        10.1
2        2        20.2
3        3        30.3
4        4        40.4
</pre></div>
</div>
<p>We can add new columns by using named column expressions</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">bigger_expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">int_col</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;bigger_ints&#39;</span><span class="p">)</span>
<span class="n">proj2</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s">&#39;int_col&#39;</span><span class="p">,</span> <span class="n">bigger_expr</span><span class="p">]</span>
<span class="n">proj2</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>   int_col  bigger_ints
0        0            0
1        1            2
2        2            4
3        3            6
4        4            8
</pre></div>
</div>
<p>Adding columns is a shortcut for projection. In Ibis, adding columns
always produces a new table reference</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">table2</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">bigger_expr</span><span class="p">)</span>
<span class="n">table2</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">
    id bool_col  tinyint_col  smallint_col  int_col  bigint_col  float_col  0  310     True            0             0        0           0        0.0
1  311    False            1             1        1          10        1.1
2  312     True            2             2        2          20        2.2
3  313    False            3             3        3          30        3.3
4  314     True            4             4        4          40        4.4

   double_col date_string_col string_col           timestamp_col  year  month  0         0.0        02/01/09          0 2009-02-01 00:00:00.000  2009      2
1        10.1        02/01/09          1 2009-02-01 00:01:00.000  2009      2
2        20.2        02/01/09          2 2009-02-01 00:02:00.100  2009      2
3        30.3        02/01/09          3 2009-02-01 00:03:00.300  2009      2
4        40.4        02/01/09          4 2009-02-01 00:04:00.600  2009      2

   bigger_ints
0            0
1            2
2            4
3            6
4            8
</pre>
<p>In more complicated projections involving joins, we may need to refer to
all of the columns in a same at once. This is how <code class="docutils literal"><span class="pre">add_column</span></code> works.
We just pass the whole table in the projection:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">table</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">table</span><span class="p">,</span> <span class="n">bigger_expr</span><span class="p">])</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">
     id bool_col  tinyint_col  smallint_col  int_col  bigint_col  float_col  0  1200     True            0             0        0           0        0.0
1  1201    False            1             1        1          10        1.1
2  1202     True            2             2        2          20        2.2
3  1203    False            3             3        3          30        3.3
4  1204     True            4             4        4          40        4.4

   double_col date_string_col string_col           timestamp_col  year  month  0         0.0        05/01/09          0 2009-05-01 00:00:00.000  2009      5
1        10.1        05/01/09          1 2009-05-01 00:01:00.000  2009      5
2        20.2        05/01/09          2 2009-05-01 00:02:00.100  2009      5
3        30.3        05/01/09          3 2009-05-01 00:03:00.300  2009      5
4        40.4        05/01/09          4 2009-05-01 00:04:00.600  2009      5

   bigger_ints
0            0
1            2
2            4
3            6
4            8
</pre>
<p>To use constants in projections, we have to use a special
<code class="docutils literal"><span class="pre">ibis.literal</span></code> function</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">foo_constant</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">bigint_col</span><span class="p">,</span> <span class="n">foo_constant</span><span class="p">])</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>   bigint_col  foo
0           0    5
1          10    5
2          20    5
3          30    5
4          40    5
</pre></div>
</div>
</div>
<div class="section" id="joins">
<h1>Joins<a class="headerlink" href="#joins" title="Permalink to this headline">¶</a></h1>
<p>Ibis attempts to provide good support for all the standard relational
joins supported by Impala, Hive, and other relational databases.</p>
<ul class="simple">
<li>inner, outer, left, right joins</li>
<li>semi and anti-joins</li>
</ul>
<p>To illustrate the joins we&#8217;ll use the TPC-H tables for now</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">region</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;tpch_region&#39;</span><span class="p">)</span>
<span class="n">nation</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;tpch_nation&#39;</span><span class="p">)</span>
<span class="n">customer</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;tpch_customer&#39;</span><span class="p">)</span>
<span class="n">lineitem</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;tpch_lineitem&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">region</span></code> and <code class="docutils literal"><span class="pre">nation</span></code> are connected by their respective
<code class="docutils literal"><span class="pre">regionkey</span></code> columns</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">join_expr</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">r_regionkey</span> <span class="o">==</span> <span class="n">nation</span><span class="o">.</span><span class="n">n_regionkey</span>
<span class="n">joined</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">inner_join</span><span class="p">(</span><span class="n">nation</span><span class="p">,</span> <span class="n">join_expr</span><span class="p">)</span>
</pre></div>
</div>
<p>If you have multiple join conditions, either compose them yourself (like
filters) or pass a list to the join function</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">join_exprs</span> <span class="o">=</span> <span class="p">[</span><span class="n">cond1</span><span class="p">,</span> <span class="n">cond2</span><span class="p">,</span> <span class="n">cond3</span><span class="p">]</span>
<span class="n">joined</span> <span class="o">=</span> <span class="n">table1</span><span class="o">.</span><span class="n">inner_join</span><span class="p">(</span><span class="n">table2</span><span class="p">,</span> <span class="n">join_exprs</span><span class="p">)</span>
</pre></div>
</div>
<p>Once you&#8217;ve joined tables, you don&#8217;t necessarily have anything yet. I&#8217;ll
put it in big letters</p>
</div>
<div class="section" id="joins-are-declarations-of-intent">
<h1>Joins are declarations of intent<a class="headerlink" href="#joins-are-declarations-of-intent" title="Permalink to this headline">¶</a></h1>
<p>After calling the join function (which validates the join condition, of
course), you may perform any number of other operations:</p>
<ul class="simple">
<li>Aggregation</li>
<li>Projection</li>
<li>Filtering</li>
</ul>
<p>and so forth. Most importantly, depending on your schemas, the joined
tables may include overlapping column names that could create a conflict
if not addressed directly. Some other systems, like pandas, handle this
by applying suffixes to the overlapping column names and computing the
fully joined tables immediately. We don&#8217;t do this.</p>
<p>So, with the above data, suppose we just want the region name and all
the nation table data. We can then make a projection on the joined
reference:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">table_ref</span> <span class="o">=</span> <span class="n">joined</span><span class="p">[</span><span class="n">nation</span><span class="p">,</span> <span class="n">region</span><span class="o">.</span><span class="n">r_name</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;region&#39;</span><span class="p">)]</span>
<span class="n">table_ref</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="s">&#39;n_nationkey&#39;</span><span class="p">,</span> <span class="s">&#39;n_name&#39;</span><span class="p">,</span> <span class="s">&#39;n_regionkey&#39;</span><span class="p">,</span> <span class="s">&#39;n_comment&#39;</span><span class="p">,</span> <span class="s">&#39;region&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">table_ref</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">
   n_nationkey      n_name  n_regionkey  0           16  MOZAMBIQUE            0
1           15     MOROCCO            0
2           14       KENYA            0
3            5    ETHIOPIA            0
4            0     ALGERIA            0

                                           n_comment  region
0      s. ironic, unusual asymptotes wake blithely r  AFRICA
1  rns. blithely bold courts among the closely re...  AFRICA
2   pending excuses haggle furiously deposits. pe...  AFRICA
3                    ven packages wake quickly. regu  AFRICA
4   haggle. carefully final deposits detect slyly...  AFRICA
</pre>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">agged</span> <span class="o">=</span> <span class="n">table_ref</span><span class="o">.</span><span class="n">aggregate</span><span class="p">([</span><span class="n">table_ref</span><span class="o">.</span><span class="n">n_name</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;nrows&#39;</span><span class="p">)],</span> <span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;region&#39;</span><span class="p">])</span>
<span class="n">agged</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>        region  nrows
0       EUROPE      5
1      AMERICA      5
2  MIDDLE EAST      5
3         ASIA      5
4       AFRICA      5
</pre></div>
</div>
<p>Things like <code class="docutils literal"><span class="pre">group_by</span></code> work with unmaterialized joins, too, as you
would hope.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">joined</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">r_name</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>        r_name  count
0       EUROPE      5
1      AMERICA      5
2  MIDDLE EAST      5
3         ASIA      5
4       AFRICA      5
</pre></div>
</div>
</div>
<div class="section" id="explicit-join-materialization">
<h1>Explicit join materialization<a class="headerlink" href="#explicit-join-materialization" title="Permalink to this headline">¶</a></h1>
<p>If you&#8217;re lucky enough to have two table schemas with no overlapping
column names (lucky you!), the join can be <em>materialized</em> without having
to perform some other relational algebra operation:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">joined</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">inner_join</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">join_expr</span><span class="p">)</span><span class="o">.</span><span class="n">materialize</span><span class="p">()</span>
</pre></div>
</div>
<p>Note that this is equivalent to doing</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">joined</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">)[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>
</pre></div>
</div>
<p>i.e., joining and then selecting all columns from both joined tables. If
there is a name overlap, just like with the equivalent projection, there
will be an immediate error.</p>
</div>
<div class="section" id="writing-down-join-keys">
<h1>Writing down join keys<a class="headerlink" href="#writing-down-join-keys" title="Permalink to this headline">¶</a></h1>
<p>In addition to having explicit comparison expressions as join keys, you
can also write down column names, or use expressions referencing the
joined tables, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">joined</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;a_key1&#39;</span><span class="p">,</span> <span class="s">&#39;b_key2&#39;</span><span class="p">)])</span>

<span class="n">joined2</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">[(</span><span class="n">left_expr</span><span class="p">,</span> <span class="n">right_expr</span><span class="p">)])</span>

<span class="n">joined3</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;common_key&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>These will be compared for equality when performing the join; if you
want non-equality conditions in the join, you will have to form those
yourself.</p>
</div>
<div class="section" id="join-referential-nuances">
<h1>Join referential nuances<a class="headerlink" href="#join-referential-nuances" title="Permalink to this headline">¶</a></h1>
<p>There&#8217;s nothing to stop you from doing many joins in succession, and, in
fact, with complex schemas it will be to your advantage to build the
joined table references for your analysis first, then reuse the objects
as you go:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">joined_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">key1</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">key2</span><span class="p">)</span>
               <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">key3</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">key4</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">key5</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">key6</span><span class="p">]))</span>
</pre></div>
</div>
<p>Note that, at least right now, you need to provide explicit comparison
expressions (or tuples of column references) referencing the joined
tables.</p>
</div>
<div class="section" id="aggregating-joined-table-with-metrics-involving-more-than-one-base-reference">
<h1>Aggregating joined table with metrics involving more than one base reference<a class="headerlink" href="#aggregating-joined-table-with-metrics-involving-more-than-one-base-reference" title="Permalink to this headline">¶</a></h1>
<p>Let&#8217;s consider the case similar to the SQL query</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT a.key, sum(a.foo - b.bar) AS metric
FROM a
  JOIN b
    ON a.key = b.key
GROUP BY 1
</pre></div>
</div>
<p>I&#8217;ll use a somewhat contrived example using the data we already have to
show you what this looks like. Take the <code class="docutils literal"><span class="pre">functional.alltypes</span></code> table,
and suppose we want to compute the <strong>mean absolute deviation (MAD) from
the hourly mean of the double_col</strong>. Silly, I know, but bear with me.</p>
<p>First, the hourly mean:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">table</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;functional_alltypes&#39;</span><span class="p">)</span>

<span class="n">hour_dim</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">timestamp_col</span><span class="o">.</span><span class="n">hour</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;hour&#39;</span><span class="p">)</span>

<span class="n">hourly_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">hour_dim</span><span class="p">)</span>
               <span class="o">.</span><span class="n">aggregate</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">double_col</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;avg_double&#39;</span><span class="p">)]))</span>
<span class="n">hourly_mean</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>   hour  avg_double
0     4       45.45
1     2       45.45
2     0       45.45
3     1       45.45
4     5       45.45
5     3       45.45
</pre></div>
</div>
<p>Okay, great, now how about the MAD? The only trick here is that we can
form an aggregate metric from the two tables, and we then have to join
it later. Ibis <strong>will not</strong> figure out how to join the tables
automatically for us.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">mad</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">double_col</span> <span class="o">-</span> <span class="n">hourly_mean</span><span class="o">.</span><span class="n">avg_double</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;MAD&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This metric is only valid if used in the context of <code class="docutils literal"><span class="pre">table</span></code> joined
with <code class="docutils literal"><span class="pre">hourly_mean</span></code>, so let&#8217;s do that. Writing down the join condition
is seriously a matter of writing:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">join_expr</span> <span class="o">=</span> <span class="n">hour_dim</span> <span class="o">==</span> <span class="n">hourly_mean</span><span class="o">.</span><span class="n">hour</span>
</pre></div>
</div>
<p>Now let&#8217;s compute the MAD grouped by <code class="docutils literal"><span class="pre">string_col</span></code></p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">inner_join</span><span class="p">(</span><span class="n">hourly_mean</span><span class="p">,</span> <span class="n">join_expr</span><span class="p">)</span>
          <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">string_col</span><span class="p">)</span>
          <span class="o">.</span><span class="n">aggregate</span><span class="p">([</span><span class="n">mad</span><span class="p">]))</span>
<span class="n">result</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>  string_col    mad
0          7  25.25
1          6  15.15
2          2  25.25
3          4   5.05
4          8  35.35
5          0  45.45
6          5   5.05
7          3  15.15
8          9  45.45
9          1  35.35
</pre></div>
</div>
</div>
<div class="section" id="sorting">
<h1>Sorting<a class="headerlink" href="#sorting" title="Permalink to this headline">¶</a></h1>
<p>Sorting tables works similarly to the SQL <code class="docutils literal"><span class="pre">ORDER</span> <span class="pre">BY</span></code> clause. We use
the <code class="docutils literal"><span class="pre">sort_by</span></code> function and pass one of the following:</p>
<ul class="simple">
<li>Column names</li>
<li>Column expressions</li>
<li>One of these, with a False (descending order) or True (ascending
order) qualifier</li>
</ul>
<p>So, to sort by <code class="docutils literal"><span class="pre">total</span></code> in ascending order we write:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">table</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="s">&#39;total&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>or by <code class="docutils literal"><span class="pre">key</span></code> then by <code class="docutils literal"><span class="pre">total</span></code> in descending order</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">table</span><span class="o">.</span><span class="n">sort_by</span><span class="p">([</span><span class="s">&#39;key&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;total&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)])</span>
</pre></div>
</div>
<p>For descending sort order, there is a convenience function <code class="docutils literal"><span class="pre">desc</span></code>
which can wrap sort keys</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">ibis</span> <span class="kn">import</span> <span class="n">desc</span>
<span class="n">table</span><span class="o">.</span><span class="n">sort_by</span><span class="p">([</span><span class="s">&#39;key&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">total</span><span class="p">)])</span>
</pre></div>
</div>
<p>Here&#8217;s a concrete example involving filters, custom grouping dimension,
and sorting</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">table</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s">&#39;functional_alltypes&#39;</span><span class="p">)</span>

<span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;string_col&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">bigint_col</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">)</span><span class="o">.</span><span class="n">ifelse</span><span class="p">(</span><span class="s">&#39;high&#39;</span><span class="p">,</span> <span class="s">&#39;low&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;bigint_tier&#39;</span><span class="p">)]</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">double_col</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s">&#39;total&#39;</span><span class="p">)]</span>

<span class="n">agged</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span>
         <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">int_col</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
         <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">metrics</span><span class="p">))</span>

<span class="n">sorted_agged</span> <span class="o">=</span> <span class="n">agged</span><span class="o">.</span><span class="n">sort_by</span><span class="p">([</span><span class="s">&#39;bigint_tier&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;total&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)])</span>
<span class="n">sorted_agged</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>  string_col bigint_tier  total
0          7        high  51611
1          6        high  44238
2          5        high  36865
3          4         low  29492
4          3         low  22119
5          2         low  14746
6          1         low   7373
7          0         low      0
</pre></div>
</div>
<p>For sorting in descending order, you can use the special <code class="docutils literal"><span class="pre">ibis.desc</span></code>
function:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">agged</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="s">&#39;total&#39;</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>  string_col bigint_tier  total
0          7        high  51611
1          6        high  44238
2          5        high  36865
3          4         low  29492
4          3         low  22119
5          2         low  14746
6          1         low   7373
7          0         low      0
</pre></div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="3.html" class="btn btn-neutral float-right" title="Type casting">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="1.html" class="btn btn-neutral" title="Basics: Aggregation, filtering, limits"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Cloudera, Inc..
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-65303298-2', 'auto');
  ga('send', 'pageview');

</script>


</body>
</html>